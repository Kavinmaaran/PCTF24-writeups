# Corrupted Key

In this challenge, you are given a dump of a private key, with some missing values.
The data given is the output you would get when you use 
```bash
openssl asn1parse -in private.pem
```
When referring to the [RFC](https://www.rfc-editor.org/rfc/rfc8017#appendix-A.1.2) in PKCS#1 format, you will find this
```
RSAPrivateKey ::= SEQUENCE {
       version           Version,
       modulus           INTEGER,  -- n
       publicExponent    INTEGER,  -- e
       privateExponent   INTEGER,  -- d
       prime1            INTEGER,  -- p
       prime2            INTEGER,  -- q
       exponent1         INTEGER,  -- d mod (p-1)
       exponent2         INTEGER,  -- d mod (q-1)
       coefficient       INTEGER,  -- (inverse of q) mod p
       otherPrimeInfos   OtherPrimeInfos OPTIONAL
   }
```
Comparing with the private key we have received from question
```
0:d=0  hl=4 l=1187 cons: SEQUENCE          
4:d=1  hl=2 l=   1 prim: INTEGER           :00
7:d=1  hl=4 l= 257 prim: INTEGER           :F805C3BB46006897829ADD84A3421242DE9C0C1AC260806AFFE7C16E955CEC804A9683CCA4B607CE96AFBB4D6E55363201FAFE54A4C7FF91D4BA59D77F1B0BE35F02AB8140B8C618747ECD4C5E241F1E6C2548081EA0B52BCE84D6D24F2E981B0E7A0D46FFB41EE0B233B4C0BB5FD39061D7EC033495FF6DBDD96803674F95ADE6E34D111BE528EF055EAE9AD077DBDB0402B7A0A716EB78D524CA94C1628624EB9622CE92E0B5B9C30ED1870C6799B808C391B3CB2E3936E6B09C31C49668F7F7CD43623333F1A532E513364E511C4639CF0FE77EA3BCCA4E105E9C53485D4509BED7F661A6FBE27AE556EC63F122BB8C359D7C1E740B159947DCB9F18B88CB
268:d=1  hl=2 l=   3 prim: INTEGER         :010001
273:d=1  hl=4 l= 256 prim: INTEGER         :XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
533:d=1  hl=3 l= 129 prim: INTEGER         :XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
665:d=1  hl=3 l= 129 prim: INTEGER         :FC12B6905BF1D20EBE695A6FA4D46C1EABB82CB739441A5141FBBDBEF10EE757D719C8CC9882AB8D70B2C7EB79EF67D39D639D2685B44FA21FCED95A7E656429CECE26558FECE349B736D6488D7C5793CC4EECEA08F0XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
797:d=1  hl=3 l= 128 prim: INTEGER         :XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
928:d=1  hl=3 l= 129 prim: INTEGER         :XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
1060:d=1  hl=3 l= 128 prim: INTEGER        :XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
```
We find RSA modulus N and a large contiguous portion of the most significant bits of prime2 (q). We can now use lattices to factor the RSA modulus N using the MSB of q. 

You can read more about the approach from this [research paper.](https://eprint.iacr.org/2020/1506.pdf) 

Using SageMath module, you can find the least significant bits of q.  

```python
from sage.all import *
from sage.modules.free_module_integer import IntegerLattice

N = 0xF805C3BB46006897829ADD84A3421242DE9C0C1AC260806AFFE7C16E955CEC804A9683CCA4B607CE96AFBB4D6E55363201FAFE54A4C7FF91D4BA59D77F1B0BE35F02AB8140B8C618747ECD4C5E241F1E6C2548081EA0B52BCE84D6D24F2E981B0E7A0D46FFB41EE0B233B4C0BB5FD39061D7EC033495FF6DBDD96803674F95ADE6E34D111BE528EF055EAE9AD077DBDB0402B7A0A716EB78D524CA94C1628624EB9622CE92E0B5B9C30ED1870C6799B808C391B3CB2E3936E6B09C31C49668F7F7CD43623333F1A532E513364E511C4639CF0FE77EA3BCCA4E105E9C53485D4509BED7F661A6FBE27AE556EC63F122BB8C359D7C1E740B159947DCB9F18B88CB
b = 0xFC12B6905BF1D20EBE695A6FA4D46C1EABB82CB739441A5141FBBDBEF10EE757D719C8CC9882AB8D70B2C7EB79EF67D39D639D2685B44FA21FCED95A7E656429CECE26558FECE349B736D6488D7C5793CC4EECEA08F0

l = 84*4
a = pow(2, l) * b
R = pow(2, l)

m = Matrix(QQ, 3, 3, [pow(R,2), R*a, 0, 0, R, a, 0, 0, N])

reduced = IntegerLattice(m)

l = list(reduced.shortest_vector())

v2 = l[0]//pow(R,2)
v1 = l[1]//R
v0 = l[2]

x = PolynomialRing(RationalField(), 'x').gen()
f = v2 * pow(x,2) + v1 * x + v0

print(f.roots(ring=QQbar))
```

You will get two solutions 
```python
[(-1.0167207181057200?e102, 1), (8.334976439149546?e100, 1)]
```
but only one of the solutions is a positive integer. Converting the second solution to hex, we get
```python
print(Integer([i[0] for i in f.roots(ring=QQbar)][1]).hex())
```
```bash
986da9802d6ecb1e4da15d3e0a60f75389898ddb19dd604fbf8528366282323cf7571118895359f27583
```

Hence we have found complete q
```python
q = 0xFC12B6905BF1D20EBE695A6FA4D46C1EABB82CB739441A5141FBBDBEF10EE757D719C8CC9882AB8D70B2C7EB79EF67D39D639D2685B44FA21FCED95A7E656429CECE26558FECE349B736D6488D7C5793CC4EECEA08F0986da9802d6ecb1e4da15d3e0a60f75389898ddb19dd604fbf8528366282323cf7571118895359f27583
```
Now using N and p, we can find q
```python
n = 0xF805C3BB46006897829ADD84A3421242DE9C0C1AC260806AFFE7C16E955CEC804A9683CCA4B607CE96AFBB4D6E55363201FAFE54A4C7FF91D4BA59D77F1B0BE35F02AB8140B8C618747ECD4C5E241F1E6C2548081EA0B52BCE84D6D24F2E981B0E7A0D46FFB41EE0B233B4C0BB5FD39061D7EC033495FF6DBDD96803674F95ADE6E34D111BE528EF055EAE9AD077DBDB0402B7A0A716EB78D524CA94C1628624EB9622CE92E0B5B9C30ED1870C6799B808C391B3CB2E3936E6B09C31C49668F7F7CD43623333F1A532E513364E511C4639CF0FE77EA3BCCA4E105E9C53485D4509BED7F661A6FBE27AE556EC63F122BB8C359D7C1E740B159947DCB9F18B88CB
p= 0xFC12B6905BF1D20EBE695A6FA4D46C1EABB82CB739441A5141FBBDBEF10EE757D719C8CC9882AB8D70B2C7EB79EF67D39D639D2685B44FA21FCED95A7E656429CECE26558FECE349B736D6488D7C5793CC4EECEA08F0986DA9802D6ECB1E4DA15D3E0A60F75389898DDB19DD604FBF8528366282323CF7571118895359F27583
q = n//p
print("n = ", n)
print("p = ", p)
print("q = ", q)
```
Output:
```bash
n =  31309942250109788963710053900105470931728479585473432910728497122915961216610297757215830820865866432741141373404360787181153468850176592962510550548926709387153987928423657462016775611707832901753498922883400851822838682287785822666492466494404709462989395681334153082077395924909026597458310681032904088355553848586963428277530324846765954151448074550602359849340833403302135004131805540374157309318891346156191496610099889684371658906325803407691055963119660038536610844880011346252626617567443512036277136986556466149954453688344994579936048891138178018218169585071481134701510018138045960008118715743109168990411
p =  177011749267562233723260739154445916747032467663966286045165723269130216239620885943995484700076567362800747347252620193573745455672581187751021856277418010794848761012301237936783217769689584667771103550132603543801393279083810732822950541506655655449619687882314776729773906819437131459993833781110959666563
q =  176880587755693119565264335782772895881377729248017841803389123786617491210818922548770672250162709205150843228502139657296024149434834937101844941235221332365555847347732219502924282153258381051516769815355049768680694733246636435520174089567451720211555723757289115276622305420278538337100664241348415292697
```

Now we can use [rsatool.py](https://github.com/ius/rsatool) to reconstruct the private key
```bash
./rsatool.py -n 31309942250109788963710053900105470931728479585473432910728497122915961216610297757215830820865866432741141373404360787181153468850176592962510550548926709387153987928423657462016775611707832901753498922883400851822838682287785822666492466494404709462989395681334153082077395924909026597458310681032904088355553848586963428277530324846765954151448074550602359849340833403302135004131805540374157309318891346156191496610099889684371658906325803407691055963119660038536610844880011346252626617567443512036277136986556466149954453688344994579936048891138178018218169585071481134701510018138045960008118715743109168990411 -p 177011749267562233723260739154445916747032467663966286045165723269130216239620885943995484700076567362800747347252620193573745455672581187751021856277418010794848761012301237936783217769689584667771103550132603543801393279083810732822950541506655655449619687882314776729773906819437131459993833781110959666563 -q 176880587755693119565264335782772895881377729248017841803389123786617491210818922548770672250162709205150843228502139657296024149434834937101844941235221332365555847347732219502924282153258381051516769815355049768680694733246636435520174089567451720211555723757289115276622305420278538337100664241348415292697 > private.pem
```

Now you can ssh into the server as given in the question
```bash
ssh -i private.pem alice@35.200.161.189
```
Output:
```bash
PTY allocation request failed on channel 0
p_ctf{111K3P1N34PP130NP1ZZ4:)}
Connection to 35.200.161.189 closed.
```